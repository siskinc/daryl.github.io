<!doctype html>
<html lang="en-us">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>redis源码解读--动态字符串SDSHDR | Daryl&#39;s Blog</title>
    <meta property="og:title" content="redis源码解读--动态字符串SDSHDR - Daryl&#39;s Blog">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2019-07-25T16:54:31&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2019-07-25T16:54:31&#43;08:00'>
        
    <meta name="Keywords" content="golang,go语言,go语言笔记,java,android,博客,项目管理,python,软件架构,公众号,小程序,Daryl">
    <meta name="description" content="redis源码解读--动态字符串SDSHDR">
        
    <meta name="author" content="Daryl">
    <meta property="og:url" content="https://siskinc.github.io/post/redis%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2sdshdr/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://siskinc.github.io/">
                        Daryl&#39;s Blog
                    </a>
                
                <p class="description">专注于Go语言(golang)、Python、项目管理、软件架构</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://siskinc.github.io/">首页</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#sds">sds</a></li>
    <li><a href="#sdshdr">sdshdr</a></li>
    <li><a href="#sds中的宏定义函数">SDS中的宏定义函数</a>
      <ul>
        <li><a href="#sds_hdr_varts">SDS_HDR_VAR(T,s)</a></li>
        <li><a href="#sds_hdrts">SDS_HDR(T,s)</a></li>
        <li><a href="#sds_type_5_lenf">SDS_TYPE_5_LEN(f)</a></li>
        <li><a href="#static-inline-size_t-sdslenconst-sds-s">static inline size_t sdslen(const sds s)</a></li>
        <li><a href="#static-inline-size_t-sdsavailconst-sds-s">static inline size_t sdsavail(const sds s)</a></li>
        <li><a href="#static-inline-void-sdssetlensds-s-size_t-newlen">static inline void sdssetlen(sds s, size_t newlen)</a></li>
        <li><a href="#static-inline-void-sdsinclensds-s-size_t-inc">static inline void sdsinclen(sds s, size_t inc)</a></li>
        <li><a href="#static-inline-size_t-sdsallocconst-sds-s">static inline size_t sdsalloc(const sds s)</a></li>
        <li><a href="#static-inline-void-sdssetallocsds-s-size_t-newlen">static inline void sdssetalloc(sds s, size_t newlen)</a></li>
      </ul>
    </li>
    <li><a href="#sds函数">SDS函数</a>
      <ul>
        <li><a href="#sds-sdsnewlenconst-void-init-size_t-initlen">sds sdsnewlen(const void *init, size_t initlen)</a></li>
        <li><a href="#扩大sds的空闲空间----sdsmakeroomfor函数">扩大sds的空闲空间 &ndash; sdsMakeRoomFor函数</a></li>
        <li><a href="#sdsremovefreespace">sdsRemoveFreeSpace</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if(leftPos<220){
                postToc.css({"width":leftPos-10,"margin-left":(0-leftPos)})
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">redis源码解读--动态字符串SDSHDR</h1>
        </header>
        <date class="post-meta meta-date">
            2019年7月25日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/redis'>Redis</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="clear" style="display: none">
            <div class="toc-article">
                <div class="toc-title">文章目录</div>
            </div>
        </div>
        
        <div class="post-content">
            <p>阅读源码: sds.h sds.c</p>
<p>SDSHDR 全称 Simple Dynamic Strings Header</p>
<h2 id="sds">sds</h2>
<blockquote>
<p>char *的别名</p>
</blockquote>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#000;font-weight:bold">typedef</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>sds;

</code></pre></td></tr></table>
</div>
</div><h2 id="sdshdr">sdshdr</h2>
<blockquote>
<p>sdshdr有好几个类别，它们分别是：sdshdr5，sdshdr8，sdshdr16，sdshdr32，sdshdr64，其中sdshdr5是不使用的</p>
</blockquote>
<p>源码如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#998;font-style:italic">/* Note: sdshdr5 is never used, we just access the flags byte directly.
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> * However is here to document the layout of type 5 SDS strings. */</span>

<span style="color:#000;font-weight:bold">struct</span> <span style="color:#900;font-weight:bold">__attribute__</span> ((__packed__)) sdshdr5 {

    <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> flags; <span style="color:#998;font-style:italic">/* 3 lsb of type, and 5 msb of string length */</span>

    <span style="color:#458;font-weight:bold">char</span> buf[];

};

<span style="color:#000;font-weight:bold">struct</span> <span style="color:#900;font-weight:bold">__attribute__</span> ((__packed__)) sdshdr8 {

    uint8_t len; <span style="color:#998;font-style:italic">/* used */</span>

    uint8_t alloc; <span style="color:#998;font-style:italic">/* excluding the header and null terminator */</span>

    <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> flags; <span style="color:#998;font-style:italic">/* 3 lsb of type, 5 unused bits */</span>

    <span style="color:#458;font-weight:bold">char</span> buf[];

};

<span style="color:#000;font-weight:bold">struct</span> <span style="color:#900;font-weight:bold">__attribute__</span> ((__packed__)) sdshdr16 {

    uint16_t len; <span style="color:#998;font-style:italic">/* used */</span>

    uint16_t alloc; <span style="color:#998;font-style:italic">/* excluding the header and null terminator */</span>

    <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> flags; <span style="color:#998;font-style:italic">/* 3 lsb of type, 5 unused bits */</span>

    <span style="color:#458;font-weight:bold">char</span> buf[];

};

<span style="color:#000;font-weight:bold">struct</span> <span style="color:#900;font-weight:bold">__attribute__</span> ((__packed__)) sdshdr32 {

    uint32_t len; <span style="color:#998;font-style:italic">/* used */</span>

    uint32_t alloc; <span style="color:#998;font-style:italic">/* excluding the header and null terminator */</span>

    <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> flags; <span style="color:#998;font-style:italic">/* 3 lsb of type, 5 unused bits */</span>

    <span style="color:#458;font-weight:bold">char</span> buf[];

};

<span style="color:#000;font-weight:bold">struct</span> <span style="color:#900;font-weight:bold">__attribute__</span> ((__packed__)) sdshdr64 {

    uint64_t len; <span style="color:#998;font-style:italic">/* used */</span>

    uint64_t alloc; <span style="color:#998;font-style:italic">/* excluding the header and null terminator */</span>

    <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> flags; <span style="color:#998;font-style:italic">/* 3 lsb of type, 5 unused bits */</span>

    <span style="color:#458;font-weight:bold">char</span> buf[];

};

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>这五个结构体中，len表示字符串的长度，alloc表示buf指针分配空间的大小，flags表示该字符串的类型(sdshdr5，sdshdr8，sdshdr16，sdshdr32，sdshdr64),是由flags的第三位表示的，至于为何怎么说，请看下方的源码：</p>
</blockquote>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#999;font-weight:bold;font-style:italic">#define SDS_TYPE_5  0
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#999;font-weight:bold;font-style:italic">#define SDS_TYPE_8  1
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#999;font-weight:bold;font-style:italic">#define SDS_TYPE_16 2
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#999;font-weight:bold;font-style:italic">#define SDS_TYPE_32 3
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#999;font-weight:bold;font-style:italic">#define SDS_TYPE_64 4
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#999;font-weight:bold;font-style:italic">#define SDS_TYPE_MASK 7
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>可以看出SDS_TYPE只占用了0,1,2,3,4五个数字，正好占用三位，我们就可以使用flags&amp;SDS_TYPE_MASK来获取动态字符串对应的字符串类型</p>
</blockquote>
<p><strong>注意一个小细节：<strong>attribute</strong> ((<strong>packed</strong>))</strong>，这一段代码的作用是<strong>取消编译阶段的内存优化对齐功能</strong>。</p>
<p>例如：struct aa {char a; int b;}; sizeof(aa) == 8;</p>
<p>但是struct <strong>attribute</strong> ((<strong>packed</strong>)) aa {char a; int b;}; sizeof(aa) == 5;</p>
<p>这个很重要，redis源码中不是直接对sdshdr某一个类型操作，往往参数都是sds，而sds就是结构体中的buf，在后面的源码分析中，你可能会经常看见s[-1]这种魔法一般的操作，而按照sdshdr内存分布s[-1]就是sdshdr中flags变量，由此可以获取到该sds指向的字符串的类型。</p>
<h2 id="sds中的宏定义函数">SDS中的宏定义函数</h2>
<h3 id="sds_hdr_varts">SDS_HDR_VAR(T,s)</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#999;font-weight:bold;font-style:italic">#define SDS_HDR_VAR(T,s) struct sdshdr##T *sh = (void*)((s)-(sizeof(struct sdshdr##T)));
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>查看这段代码首先得明白 C 语言中的宏定义##操作符，我在此就不再解释了</p>
</blockquote>
<p>这段代码就很骚气了，用个例子来解释：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
SDS_HDR_VAR(<span style="color:#099">8</span>,s);

<span style="color:#998;font-style:italic">//下面是对应宏定义翻译的产物
</span><span style="color:#998;font-style:italic"></span>
<span style="color:#000;font-weight:bold">struct</span> sdshdr8 <span style="color:#000;font-weight:bold">*</span>sh <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span>)((s)<span style="color:#000;font-weight:bold">-</span>(<span style="color:#000;font-weight:bold">sizeof</span>(<span style="color:#000;font-weight:bold">struct</span> sdshdr<span style="color:#a61717;background-color:#e3d2d2">##</span>T)));

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>这样就可以根据<strong>指向buf的sds变量s</strong>得到sdshdr8的指针，是不是感觉很神奇？</p>
</blockquote>
<h3 id="sds_hdrts">SDS_HDR(T,s)</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#999;font-weight:bold;font-style:italic">#define SDS_HDR(T,s) ((struct sdshdr##T *)((s)-(sizeof(struct sdshdr##T))))
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>同上方的函数类似，根据<strong>指向buf的sds变量s</strong>得到sdshdr的指针，只不过这里是获取的是指针地址，上方函数是创建了一个变量</p>
</blockquote>
<h3 id="sds_type_5_lenf">SDS_TYPE_5_LEN(f)</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#999;font-weight:bold;font-style:italic">#define SDS_TYPE_BITS 3
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#999;font-weight:bold;font-style:italic">#define SDS_TYPE_5_LEN(f) ((f)&gt;&gt;SDS_TYPE_BITS)
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>看名字就知道该函数就是获取sdshdr5字符串类型的长度，由于根本不使用sdshdr5类型，所以需要直接返回空，而flags成员使用最低三位有效位来表示类型，所以让f代表的flags的值右移三位即可</p>
</blockquote>
<hr>
<p>上方基本上就是sds的核心内容了，然后再看看sds中的几个内联函数</p>
<h3 id="static-inline-size_t-sdslenconst-sds-s">static inline size_t sdslen(const sds s)</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">inline</span> size_t <span style="color:#900;font-weight:bold">sdslen</span>(<span style="color:#000;font-weight:bold">const</span> sds s) {

    <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> flags <span style="color:#000;font-weight:bold">=</span> s[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>];

    <span style="color:#000;font-weight:bold">switch</span>(flags<span style="color:#000;font-weight:bold">&amp;</span>SDS_TYPE_MASK) {

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_5</span>:

            <span style="color:#000;font-weight:bold">return</span> SDS_TYPE_5_LEN(flags);

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_8</span>:

            <span style="color:#000;font-weight:bold">return</span> SDS_HDR(<span style="color:#099">8</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>len;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_16</span>:

            <span style="color:#000;font-weight:bold">return</span> SDS_HDR(<span style="color:#099">16</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>len;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_32</span>:

            <span style="color:#000;font-weight:bold">return</span> SDS_HDR(<span style="color:#099">32</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>len;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_64</span>:

            <span style="color:#000;font-weight:bold">return</span> SDS_HDR(<span style="color:#099">64</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>len;

    }

    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;

}

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>该处就使用到了取消编译阶段的内存优化对齐功能，直接使用s[-1]获取到flags成员的值，然后根据flags&amp;&amp;SDS_TYPE_MASK来获取到动态字符串对应的类型进而获取动态字符串的长度。</p>
</blockquote>
<h3 id="static-inline-size_t-sdsavailconst-sds-s">static inline size_t sdsavail(const sds s)</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">inline</span> size_t <span style="color:#900;font-weight:bold">sdsavail</span>(<span style="color:#000;font-weight:bold">const</span> sds s) {

    <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> flags <span style="color:#000;font-weight:bold">=</span> s[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>];

    <span style="color:#000;font-weight:bold">switch</span>(flags<span style="color:#000;font-weight:bold">&amp;</span>SDS_TYPE_MASK) {

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_5</span>: {

            <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;

        }

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_8</span>: {

            SDS_HDR_VAR(<span style="color:#099">8</span>,s);

            <span style="color:#000;font-weight:bold">return</span> sh<span style="color:#000;font-weight:bold">-&gt;</span>alloc <span style="color:#000;font-weight:bold">-</span> sh<span style="color:#000;font-weight:bold">-&gt;</span>len;

        }

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_16</span>: {

            SDS_HDR_VAR(<span style="color:#099">16</span>,s);

            <span style="color:#000;font-weight:bold">return</span> sh<span style="color:#000;font-weight:bold">-&gt;</span>alloc <span style="color:#000;font-weight:bold">-</span> sh<span style="color:#000;font-weight:bold">-&gt;</span>len;

        }

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_32</span>: {

            SDS_HDR_VAR(<span style="color:#099">32</span>,s);

            <span style="color:#000;font-weight:bold">return</span> sh<span style="color:#000;font-weight:bold">-&gt;</span>alloc <span style="color:#000;font-weight:bold">-</span> sh<span style="color:#000;font-weight:bold">-&gt;</span>len;

        }

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_64</span>: {

            SDS_HDR_VAR(<span style="color:#099">64</span>,s);

            <span style="color:#000;font-weight:bold">return</span> sh<span style="color:#000;font-weight:bold">-&gt;</span>alloc <span style="color:#000;font-weight:bold">-</span> sh<span style="color:#000;font-weight:bold">-&gt;</span>len;

        }

    }

    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;

}

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>获取动态字符串可使用的空间，从这里可以看出来，SDS和我平常所用到的C语言的原生字符串有差别，因为从获取可用空间的计算方法来看，并未考虑到字符串需要以\0结尾，因为结构体本身带有长度的成员len，不需要\0来做字符串结尾的判定，而且不使用\0作为结尾有很多好处，可以存储的类型多样性就提高了。</p>
</blockquote>
<h3 id="static-inline-void-sdssetlensds-s-size_t-newlen">static inline void sdssetlen(sds s, size_t newlen)</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">inline</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sdssetlen</span>(sds s, size_t newlen) {

    <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> flags <span style="color:#000;font-weight:bold">=</span> s[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>];

    <span style="color:#000;font-weight:bold">switch</span>(flags<span style="color:#000;font-weight:bold">&amp;</span>SDS_TYPE_MASK) {

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_5</span>:

            {

                <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>fp <span style="color:#000;font-weight:bold">=</span> ((<span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)s)<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;

                <span style="color:#000;font-weight:bold">*</span>fp <span style="color:#000;font-weight:bold">=</span> SDS_TYPE_5 <span style="color:#000;font-weight:bold">|</span> (newlen <span style="color:#000;font-weight:bold">&lt;&lt;</span> SDS_TYPE_BITS);

            }

            <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_8</span>:

            SDS_HDR(<span style="color:#099">8</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>len <span style="color:#000;font-weight:bold">=</span> newlen;

            <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_16</span>:

            SDS_HDR(<span style="color:#099">16</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>len <span style="color:#000;font-weight:bold">=</span> newlen;

            <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_32</span>:

            SDS_HDR(<span style="color:#099">32</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>len <span style="color:#000;font-weight:bold">=</span> newlen;

            <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_64</span>:

            SDS_HDR(<span style="color:#099">64</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>len <span style="color:#000;font-weight:bold">=</span> newlen;

            <span style="color:#000;font-weight:bold">break</span>;

    }

}

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>设置sds的长度</p>
</blockquote>
<h3 id="static-inline-void-sdsinclensds-s-size_t-inc">static inline void sdsinclen(sds s, size_t inc)</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">inline</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sdsinclen</span>(sds s, size_t inc) {

    <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> flags <span style="color:#000;font-weight:bold">=</span> s[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>];

    <span style="color:#000;font-weight:bold">switch</span>(flags<span style="color:#000;font-weight:bold">&amp;</span>SDS_TYPE_MASK) {

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_5</span>:

            {

                <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>fp <span style="color:#000;font-weight:bold">=</span> ((<span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)s)<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;

                <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> newlen <span style="color:#000;font-weight:bold">=</span> SDS_TYPE_5_LEN(flags)<span style="color:#000;font-weight:bold">+</span>inc;

                <span style="color:#000;font-weight:bold">*</span>fp <span style="color:#000;font-weight:bold">=</span> SDS_TYPE_5 <span style="color:#000;font-weight:bold">|</span> (newlen <span style="color:#000;font-weight:bold">&lt;&lt;</span> SDS_TYPE_BITS);

            }

            <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_8</span>:

            SDS_HDR(<span style="color:#099">8</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>len <span style="color:#000;font-weight:bold">+=</span> inc;

            <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_16</span>:

            SDS_HDR(<span style="color:#099">16</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>len <span style="color:#000;font-weight:bold">+=</span> inc;

            <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_32</span>:

            SDS_HDR(<span style="color:#099">32</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>len <span style="color:#000;font-weight:bold">+=</span> inc;

            <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_64</span>:

            SDS_HDR(<span style="color:#099">64</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>len <span style="color:#000;font-weight:bold">+=</span> inc;

            <span style="color:#000;font-weight:bold">break</span>;

    }

}

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>增加sds的长度</p>
</blockquote>
<h3 id="static-inline-size_t-sdsallocconst-sds-s">static inline size_t sdsalloc(const sds s)</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#998;font-style:italic">/* sdsalloc() = sdsavail() + sdslen() */</span>

<span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">inline</span> size_t <span style="color:#900;font-weight:bold">sdsalloc</span>(<span style="color:#000;font-weight:bold">const</span> sds s) {

    <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> flags <span style="color:#000;font-weight:bold">=</span> s[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>];

    <span style="color:#000;font-weight:bold">switch</span>(flags<span style="color:#000;font-weight:bold">&amp;</span>SDS_TYPE_MASK) {

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_5</span>:

            <span style="color:#000;font-weight:bold">return</span> SDS_TYPE_5_LEN(flags);

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_8</span>:

            <span style="color:#000;font-weight:bold">return</span> SDS_HDR(<span style="color:#099">8</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>alloc;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_16</span>:

            <span style="color:#000;font-weight:bold">return</span> SDS_HDR(<span style="color:#099">16</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>alloc;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_32</span>:

            <span style="color:#000;font-weight:bold">return</span> SDS_HDR(<span style="color:#099">32</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>alloc;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_64</span>:

            <span style="color:#000;font-weight:bold">return</span> SDS_HDR(<span style="color:#099">64</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>alloc;

    }

    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;

}

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>获取sds已分配空间的大小</p>
</blockquote>
<h3 id="static-inline-void-sdssetallocsds-s-size_t-newlen">static inline void sdssetalloc(sds s, size_t newlen)</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">inline</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sdssetalloc</span>(sds s, size_t newlen) {

    <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> flags <span style="color:#000;font-weight:bold">=</span> s[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>];

    <span style="color:#000;font-weight:bold">switch</span>(flags<span style="color:#000;font-weight:bold">&amp;</span>SDS_TYPE_MASK) {

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_5</span>:

            <span style="color:#998;font-style:italic">/* Nothing to do, this type has no total allocation info. */</span>

            <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_8</span>:

            SDS_HDR(<span style="color:#099">8</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>alloc <span style="color:#000;font-weight:bold">=</span> newlen;

            <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_16</span>:

            SDS_HDR(<span style="color:#099">16</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>alloc <span style="color:#000;font-weight:bold">=</span> newlen;

            <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_32</span>:

            SDS_HDR(<span style="color:#099">32</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>alloc <span style="color:#000;font-weight:bold">=</span> newlen;

            <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_64</span>:

            SDS_HDR(<span style="color:#099">64</span>,s)<span style="color:#000;font-weight:bold">-&gt;</span>alloc <span style="color:#000;font-weight:bold">=</span> newlen;

            <span style="color:#000;font-weight:bold">break</span>;

    }

}

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>设置sds已分配空间的大小</p>
</blockquote>
<h2 id="sds函数">SDS函数</h2>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
sds <span style="color:#900;font-weight:bold">sdsnewlen</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>init, size_t initlen);

sds <span style="color:#900;font-weight:bold">sdsnew</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>init);

sds <span style="color:#900;font-weight:bold">sdsempty</span>(<span style="color:#458;font-weight:bold">void</span>);

sds <span style="color:#900;font-weight:bold">sdsdup</span>(<span style="color:#000;font-weight:bold">const</span> sds s);

<span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sdsfree</span>(sds s);

sds <span style="color:#900;font-weight:bold">sdsgrowzero</span>(sds s, size_t len);

sds <span style="color:#900;font-weight:bold">sdscatlen</span>(sds s, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>t, size_t len);

sds <span style="color:#900;font-weight:bold">sdscat</span>(sds s, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>t);

sds <span style="color:#900;font-weight:bold">sdscatsds</span>(sds s, <span style="color:#000;font-weight:bold">const</span> sds t);

sds <span style="color:#900;font-weight:bold">sdscpylen</span>(sds s, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>t, size_t len);

sds <span style="color:#900;font-weight:bold">sdscpy</span>(sds s, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>t);



sds <span style="color:#900;font-weight:bold">sdscatvprintf</span>(sds s, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>fmt, va_list ap);

<span style="color:#999;font-weight:bold;font-style:italic">#ifdef __GNUC__
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
sds <span style="color:#900;font-weight:bold">sdscatprintf</span>(sds s, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>fmt, ...)

    __attribute__((format(printf, <span style="color:#099">2</span>, <span style="color:#099">3</span>)));

<span style="color:#999;font-weight:bold;font-style:italic">#else
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
sds <span style="color:#900;font-weight:bold">sdscatprintf</span>(sds s, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>fmt, ...);

<span style="color:#999;font-weight:bold;font-style:italic">#endif
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>


sds <span style="color:#900;font-weight:bold">sdscatfmt</span>(sds s, <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">*</span>fmt, ...);

sds <span style="color:#900;font-weight:bold">sdstrim</span>(sds s, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>cset);

<span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sdsrange</span>(sds s, ssize_t start, ssize_t end);

<span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sdsupdatelen</span>(sds s);

<span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sdsclear</span>(sds s);

<span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">sdscmp</span>(<span style="color:#000;font-weight:bold">const</span> sds s1, <span style="color:#000;font-weight:bold">const</span> sds s2);

sds <span style="color:#000;font-weight:bold">*</span><span style="color:#900;font-weight:bold">sdssplitlen</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>s, ssize_t len, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>sep, <span style="color:#458;font-weight:bold">int</span> seplen, <span style="color:#458;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">*</span>count);

<span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sdsfreesplitres</span>(sds <span style="color:#000;font-weight:bold">*</span>tokens, <span style="color:#458;font-weight:bold">int</span> count);

<span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sdstolower</span>(sds s);

<span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sdstoupper</span>(sds s);

sds <span style="color:#900;font-weight:bold">sdsfromlonglong</span>(<span style="color:#458;font-weight:bold">long</span> <span style="color:#458;font-weight:bold">long</span> value);

sds <span style="color:#900;font-weight:bold">sdscatrepr</span>(sds s, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>p, size_t len);

sds <span style="color:#000;font-weight:bold">*</span><span style="color:#900;font-weight:bold">sdssplitargs</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>line, <span style="color:#458;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">*</span>argc);

sds <span style="color:#900;font-weight:bold">sdsmapchars</span>(sds s, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>from, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>to, size_t setlen);

sds <span style="color:#900;font-weight:bold">sdsjoin</span>(<span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">**</span>argv, <span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>sep);

sds <span style="color:#900;font-weight:bold">sdsjoinsds</span>(sds <span style="color:#000;font-weight:bold">*</span>argv, <span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>sep, size_t seplen);



<span style="color:#998;font-style:italic">/* Low level functions exposed to the user API */</span>

sds <span style="color:#900;font-weight:bold">sdsMakeRoomFor</span>(sds s, size_t addlen);

<span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sdsIncrLen</span>(sds s, ssize_t incr);

sds <span style="color:#900;font-weight:bold">sdsRemoveFreeSpace</span>(sds s);

size_t <span style="color:#900;font-weight:bold">sdsAllocSize</span>(sds s);

<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span><span style="color:#900;font-weight:bold">sdsAllocPtr</span>(sds s);



<span style="color:#998;font-style:italic">/* Export the allocator used by SDS to the program using SDS.
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> * Sometimes the program SDS is linked to, may use a different set of
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> * allocators, but may want to allocate or free things that SDS will
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> * respectively free or allocate. */</span>

<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span><span style="color:#900;font-weight:bold">sds_malloc</span>(size_t size);

<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span><span style="color:#900;font-weight:bold">sds_realloc</span>(<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>ptr, size_t size);

<span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sds_free</span>(<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>ptr);

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>这当中的大部分函数都很简单，只是对zmalloc文件里面的函数，sds中inline函数，或者是sdsnewlen函数的一层简单调用，就不解释，我们挑几个重点的看看。</p>
</blockquote>
<h3 id="sds-sdsnewlenconst-void-init-size_t-initlen">sds sdsnewlen(const void *init, size_t initlen)</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#998;font-style:italic">/* Create a new sds string with the content specified by the &#39;init&#39; pointer
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> * and &#39;initlen&#39;.
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> * If NULL is used for &#39;init&#39; the string is initialized with zero bytes.
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> * If SDS_NOINIT is used, the buffer is left uninitialized;
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> *
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> * The string is always null-termined (all the sds strings are, always) so
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> * even if you create an sds string with:
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> *
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> * mystring = sdsnewlen(&#34;abc&#34;,3);
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> *
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> * You can print the string with printf() as there is an implicit \0 at the
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> * end of the string. However the string is binary safe and can contain
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic"> * \0 characters in the middle, as the length is stored in the sds header. */</span>

sds <span style="color:#900;font-weight:bold">sdsnewlen</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>init, size_t initlen) {

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>sh;

    sds s;

    <span style="color:#998;font-style:italic">// 根据initlen来获取合适的字符串长度
</span><span style="color:#998;font-style:italic"></span>
    <span style="color:#458;font-weight:bold">char</span> type <span style="color:#000;font-weight:bold">=</span> sdsReqType(initlen);

    <span style="color:#998;font-style:italic">/* Empty strings are usually created in order to append. Use type 8
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic">     * since type 5 is not good at this. */</span>

    <span style="color:#000;font-weight:bold">if</span> (type <span style="color:#000;font-weight:bold">==</span> SDS_TYPE_5 <span style="color:#000;font-weight:bold">&amp;&amp;</span> initlen <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>) type <span style="color:#000;font-weight:bold">=</span> SDS_TYPE_8;

    <span style="color:#998;font-style:italic">// 根据sds类型来获取该sds类型对应的结构体大小
</span><span style="color:#998;font-style:italic"></span>
    <span style="color:#458;font-weight:bold">int</span> hdrlen <span style="color:#000;font-weight:bold">=</span> sdsHdrSize(type);

    <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>fp; <span style="color:#998;font-style:italic">/* flags pointer. */</span>



    <span style="color:#998;font-style:italic">// 此处的s_malloc其实就是zmalloc函数,只是一个别名,注意这里，会给sds多增加一个字节的空间，由后面的s[initlen] = &#39;\0&#39;;可知，作者是为了兼容C语言的字符串类型，这样就可以直接使用printf来输出sds了，这样非常的方便
</span><span style="color:#998;font-style:italic"></span>
    sh <span style="color:#000;font-weight:bold">=</span> s_malloc(hdrlen<span style="color:#000;font-weight:bold">+</span>initlen<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>);

    <span style="color:#998;font-style:italic">// 如果init == &#34;SDS_NOINIT&#34;,那么就会把sds置为未知字符串，如果init == NULL，那么就会把sds置为空字符串
</span><span style="color:#998;font-style:italic"></span>
    <span style="color:#000;font-weight:bold">if</span> (init<span style="color:#000;font-weight:bold">==</span>SDS_NOINIT)

        init <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>;

    <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>init)

        memset(sh, <span style="color:#099">0</span>, hdrlen<span style="color:#000;font-weight:bold">+</span>initlen<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>);

    <span style="color:#000;font-weight:bold">if</span> (sh <span style="color:#000;font-weight:bold">==</span> <span style="color:#0086b3">NULL</span>) <span style="color:#000;font-weight:bold">return</span> <span style="color:#0086b3">NULL</span>;

    s <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)sh<span style="color:#000;font-weight:bold">+</span>hdrlen;

    fp <span style="color:#000;font-weight:bold">=</span> ((<span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)s)<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;

    <span style="color:#998;font-style:italic">// 根据sds类型来初始化sds的内容
</span><span style="color:#998;font-style:italic"></span>
    <span style="color:#000;font-weight:bold">switch</span>(type) {

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_5</span>: {

            <span style="color:#000;font-weight:bold">*</span>fp <span style="color:#000;font-weight:bold">=</span> type <span style="color:#000;font-weight:bold">|</span> (initlen <span style="color:#000;font-weight:bold">&lt;&lt;</span> SDS_TYPE_BITS);

            <span style="color:#000;font-weight:bold">break</span>;

        }

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_8</span>: {

            SDS_HDR_VAR(<span style="color:#099">8</span>,s);

            sh<span style="color:#000;font-weight:bold">-&gt;</span>len <span style="color:#000;font-weight:bold">=</span> initlen;

            sh<span style="color:#000;font-weight:bold">-&gt;</span>alloc <span style="color:#000;font-weight:bold">=</span> initlen;

            <span style="color:#000;font-weight:bold">*</span>fp <span style="color:#000;font-weight:bold">=</span> type;

            <span style="color:#000;font-weight:bold">break</span>;

        }

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_16</span>: {

            SDS_HDR_VAR(<span style="color:#099">16</span>,s);

            sh<span style="color:#000;font-weight:bold">-&gt;</span>len <span style="color:#000;font-weight:bold">=</span> initlen;

            sh<span style="color:#000;font-weight:bold">-&gt;</span>alloc <span style="color:#000;font-weight:bold">=</span> initlen;

            <span style="color:#000;font-weight:bold">*</span>fp <span style="color:#000;font-weight:bold">=</span> type;

            <span style="color:#000;font-weight:bold">break</span>;

        }

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_32</span>: {

            SDS_HDR_VAR(<span style="color:#099">32</span>,s);

            sh<span style="color:#000;font-weight:bold">-&gt;</span>len <span style="color:#000;font-weight:bold">=</span> initlen;

            sh<span style="color:#000;font-weight:bold">-&gt;</span>alloc <span style="color:#000;font-weight:bold">=</span> initlen;

            <span style="color:#000;font-weight:bold">*</span>fp <span style="color:#000;font-weight:bold">=</span> type;

            <span style="color:#000;font-weight:bold">break</span>;

        }

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SDS_TYPE_64</span>: {

            SDS_HDR_VAR(<span style="color:#099">64</span>,s);

            sh<span style="color:#000;font-weight:bold">-&gt;</span>len <span style="color:#000;font-weight:bold">=</span> initlen;

            sh<span style="color:#000;font-weight:bold">-&gt;</span>alloc <span style="color:#000;font-weight:bold">=</span> initlen;

            <span style="color:#000;font-weight:bold">*</span>fp <span style="color:#000;font-weight:bold">=</span> type;

            <span style="color:#000;font-weight:bold">break</span>;

        }

    }

    <span style="color:#998;font-style:italic">// 在初始化完成后，将init的内容拷贝进sds对象中，但是init如果原来等于SDS_NOINIT，就会被置为NULL，所以sds还是一串未知的字符串
</span><span style="color:#998;font-style:italic"></span>
    <span style="color:#000;font-weight:bold">if</span> (initlen <span style="color:#000;font-weight:bold">&amp;&amp;</span> init)

        memcpy(s, init, initlen);

    s[initlen] <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;\0&#39;</span>;

    <span style="color:#000;font-weight:bold">return</span> s;

}

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>该函数是一个生成新sds的函数，根据init指针和initlen参数来初始化sds的内容，根据init是否是SDS_NOINIT来设置是否需要使用init的内容初始化sds，如果是SDS_NOINIT，那么默认会将sds置为一串为未知的字符串，如果init为NULL。那么默认会将sds置为一个空字符串，并且sdsnewlen在为sds向系统申请一个新的空间的时候，新空间的长度是hdrlen+initlen+1，注意这里的+1，这多出来的一个字节，其实是放\0的，这样sds就可以使用C自带标准库(strlen,strtoll之类的函数)来操作sds中buf的内容，不然还得自己写一套，很是麻烦。</p>
</blockquote>
<p>以下是使用sdsnewlen函数简单调用构成的函数：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#998;font-style:italic">// 创建一个新的sds，只不过这里只会给init参数，实际上initlen是通过strlen获取的
</span><span style="color:#998;font-style:italic"></span>
sds <span style="color:#900;font-weight:bold">sdsnew</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>init);

<span style="color:#998;font-style:italic">// 创建一个空的sds
</span><span style="color:#998;font-style:italic"></span>
sds <span style="color:#900;font-weight:bold">sdsempty</span>(<span style="color:#458;font-weight:bold">void</span>);

<span style="color:#998;font-style:italic">// 根据原sds，创建一个sds的副本
</span><span style="color:#998;font-style:italic"></span>
sds <span style="color:#900;font-weight:bold">sdsdup</span>(<span style="color:#000;font-weight:bold">const</span> sds s);

</code></pre></td></tr></table>
</div>
</div><p>以下是对zmalloc里面的函数简单调用或者直接是别名的函数:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#999;font-weight:bold;font-style:italic">#define s_malloc zmalloc
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#999;font-weight:bold;font-style:italic">#define s_realloc zrealloc
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#999;font-weight:bold;font-style:italic">#define s_free zfree
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>


<span style="color:#998;font-style:italic">/* Free an sds string. No operation is performed if &#39;s&#39; is NULL. */</span>

<span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sdsfree</span>(sds s) {

    <span style="color:#000;font-weight:bold">if</span> (s <span style="color:#000;font-weight:bold">==</span> <span style="color:#0086b3">NULL</span>) <span style="color:#000;font-weight:bold">return</span>;

    s_free((<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)s<span style="color:#000;font-weight:bold">-</span>sdsHdrSize(s[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>]));

}



<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span><span style="color:#900;font-weight:bold">sds_malloc</span>(size_t size) { <span style="color:#000;font-weight:bold">return</span> s_malloc(size); }

<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span><span style="color:#900;font-weight:bold">sds_realloc</span>(<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>ptr, size_t size) { <span style="color:#000;font-weight:bold">return</span> s_realloc(ptr,size); }

<span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sds_free</span>(<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>ptr) { s_free(ptr); }

</code></pre></td></tr></table>
</div>
</div><p>在动态字符串的所有操作中，大部分会进行对内存的扩大和释放，所以得介绍一下sds中对内存扩大和释放的函数</p>
<h3 id="扩大sds的空闲空间----sdsmakeroomfor函数">扩大sds的空闲空间 &ndash; sdsMakeRoomFor函数</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
sds <span style="color:#900;font-weight:bold">sdsMakeRoomFor</span>(sds s, size_t addlen) {

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>sh, <span style="color:#000;font-weight:bold">*</span>newsh;

    size_t avail <span style="color:#000;font-weight:bold">=</span> sdsavail(s);

    size_t len, newlen;

    <span style="color:#458;font-weight:bold">char</span> type, oldtype <span style="color:#000;font-weight:bold">=</span> s[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">&amp;</span> SDS_TYPE_MASK;

    <span style="color:#458;font-weight:bold">int</span> hdrlen;



    <span style="color:#998;font-style:italic">/* Return ASAP if there is enough space left. */</span>

    <span style="color:#000;font-weight:bold">if</span> (avail <span style="color:#000;font-weight:bold">&gt;=</span> addlen) <span style="color:#000;font-weight:bold">return</span> s;



    len <span style="color:#000;font-weight:bold">=</span> sdslen(s);

    sh <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)s<span style="color:#000;font-weight:bold">-</span>sdsHdrSize(oldtype);

    newlen <span style="color:#000;font-weight:bold">=</span> (len<span style="color:#000;font-weight:bold">+</span>addlen);

    <span style="color:#000;font-weight:bold">if</span> (newlen <span style="color:#000;font-weight:bold">&lt;</span> SDS_MAX_PREALLOC)

        newlen <span style="color:#000;font-weight:bold">*=</span> <span style="color:#099">2</span>;

    <span style="color:#000;font-weight:bold">else</span>

        newlen <span style="color:#000;font-weight:bold">+=</span> SDS_MAX_PREALLOC;



    type <span style="color:#000;font-weight:bold">=</span> sdsReqType(newlen);



    <span style="color:#998;font-style:italic">/* Don&#39;t use type 5: the user is appending to the string and type 5 is
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic">     * not able to remember empty space, so sdsMakeRoomFor() must be called
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic">     * at every appending operation. */</span>

    <span style="color:#000;font-weight:bold">if</span> (type <span style="color:#000;font-weight:bold">==</span> SDS_TYPE_5) type <span style="color:#000;font-weight:bold">=</span> SDS_TYPE_8;



    hdrlen <span style="color:#000;font-weight:bold">=</span> sdsHdrSize(type);

    <span style="color:#000;font-weight:bold">if</span> (oldtype<span style="color:#000;font-weight:bold">==</span>type) {

        newsh <span style="color:#000;font-weight:bold">=</span> s_realloc(sh, hdrlen<span style="color:#000;font-weight:bold">+</span>newlen<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>);

        <span style="color:#000;font-weight:bold">if</span> (newsh <span style="color:#000;font-weight:bold">==</span> <span style="color:#0086b3">NULL</span>) <span style="color:#000;font-weight:bold">return</span> <span style="color:#0086b3">NULL</span>;

        s <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)newsh<span style="color:#000;font-weight:bold">+</span>hdrlen;

    } <span style="color:#000;font-weight:bold">else</span> {

        <span style="color:#998;font-style:italic">/* Since the header size changes, need to move the string forward,
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic">         * and can&#39;t use realloc */</span>

        newsh <span style="color:#000;font-weight:bold">=</span> s_malloc(hdrlen<span style="color:#000;font-weight:bold">+</span>newlen<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>);

        <span style="color:#000;font-weight:bold">if</span> (newsh <span style="color:#000;font-weight:bold">==</span> <span style="color:#0086b3">NULL</span>) <span style="color:#000;font-weight:bold">return</span> <span style="color:#0086b3">NULL</span>;

        memcpy((<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)newsh<span style="color:#000;font-weight:bold">+</span>hdrlen, s, len<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>);

        s_free(sh);

        s <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)newsh<span style="color:#000;font-weight:bold">+</span>hdrlen;

        s[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">=</span> type;

        sdssetlen(s, len);

    }

    sdssetalloc(s, newlen);

    <span style="color:#000;font-weight:bold">return</span> s;

}

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>该函数便是扩大sds空间，但是感觉上还是想让sds中available空间的大小能够容纳addlen大小的字符串，并不是改变了sds中buf的长度，而是改变了sds中available空间的大小，如果当前available空间的大小大于addlen的大小，那么便不作修改，如果available空间的大小小鱼addlen的大小，那么就会重新分配sds中alloc的大小，newlen并不是无脑直接让alloc加上addlen，而且使用sds的长度加上addlen的长度作为newlen，但是经常重新分配内存会对效率有所影响，但是为了防止重新分配内存对效率的影响而让newlen无脑翻倍的话，又会对内存造成影响，造成内存占用过高，但是很大一部分内存并没有使用，所以取得了一个折中的办法，就是在newlen小于SDS_MAX_PREALLOC(1M)，对newlen进行翻倍，在newlen大于SDS_MAX_PREALLOC的情况下，让newlen加上SDS_MAX_PREALLOC。</p>
</blockquote>
<h3 id="sdsremovefreespace">sdsRemoveFreeSpace</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
sds <span style="color:#900;font-weight:bold">sdsRemoveFreeSpace</span>(sds s) {

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>sh, <span style="color:#000;font-weight:bold">*</span>newsh;

    <span style="color:#458;font-weight:bold">char</span> type, oldtype <span style="color:#000;font-weight:bold">=</span> s[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">&amp;</span> SDS_TYPE_MASK;

    <span style="color:#458;font-weight:bold">int</span> hdrlen, oldhdrlen <span style="color:#000;font-weight:bold">=</span> sdsHdrSize(oldtype);

    size_t len <span style="color:#000;font-weight:bold">=</span> sdslen(s);

    sh <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)s<span style="color:#000;font-weight:bold">-</span>oldhdrlen;



    <span style="color:#998;font-style:italic">/* Check what would be the minimum SDS header that is just good enough to
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic">     * fit this string. */</span>

    type <span style="color:#000;font-weight:bold">=</span> sdsReqType(len);

    hdrlen <span style="color:#000;font-weight:bold">=</span> sdsHdrSize(type);



    <span style="color:#998;font-style:italic">/* If the type is the same, or at least a large enough type is still
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic">     * required, we just realloc(), letting the allocator to do the copy
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic">     * only if really needed. Otherwise if the change is huge, we manually
</span><span style="color:#998;font-style:italic">
</span><span style="color:#998;font-style:italic">     * reallocate the string to use the different header type. */</span>

    <span style="color:#000;font-weight:bold">if</span> (oldtype<span style="color:#000;font-weight:bold">==</span>type <span style="color:#000;font-weight:bold">||</span> type <span style="color:#000;font-weight:bold">&gt;</span> SDS_TYPE_8) {

        newsh <span style="color:#000;font-weight:bold">=</span> s_realloc(sh, oldhdrlen<span style="color:#000;font-weight:bold">+</span>len<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>);

        <span style="color:#000;font-weight:bold">if</span> (newsh <span style="color:#000;font-weight:bold">==</span> <span style="color:#0086b3">NULL</span>) <span style="color:#000;font-weight:bold">return</span> <span style="color:#0086b3">NULL</span>;

        s <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)newsh<span style="color:#000;font-weight:bold">+</span>oldhdrlen;

    } <span style="color:#000;font-weight:bold">else</span> {

        newsh <span style="color:#000;font-weight:bold">=</span> s_malloc(hdrlen<span style="color:#000;font-weight:bold">+</span>len<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>);

        <span style="color:#000;font-weight:bold">if</span> (newsh <span style="color:#000;font-weight:bold">==</span> <span style="color:#0086b3">NULL</span>) <span style="color:#000;font-weight:bold">return</span> <span style="color:#0086b3">NULL</span>;

        memcpy((<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)newsh<span style="color:#000;font-weight:bold">+</span>hdrlen, s, len<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>);

        s_free(sh);

        s <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)newsh<span style="color:#000;font-weight:bold">+</span>hdrlen;

        s[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">=</span> type;

        sdssetlen(s, len);

    }

    sdssetalloc(s, len);

    <span style="color:#000;font-weight:bold">return</span> s;

}

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>就是对sds中多余的空间进行释放，例如以前是一个sdshdr64的sds，在redis运行过程中，buf的内容被修改了，变短了，那么多出来的内容就需要释放掉，还给系统，并且，如果修改得比较多，现在一个sdshdr16的sds就能容纳下，那么当前sds的type还会被修改，因为不同的sds类型占用的空间也是不一样的，并且杀鸡焉用宰牛刀，是吧。</p>
</blockquote>
<p>其他的函数介绍意义其实并不大，都很简单，我们仅需要知道sds的内存分布，内存操作即可。</p>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="https://siskinc.github.io/">Daryl</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="https://siskinc.github.io/post/redis%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2sdshdr/">https://siskinc.github.io/post/redis%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2sdshdr/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/redis%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E5%86%85%E5%AD%98%E5%88%86%E9%85%8Dzmalloc/">redis源码解读--内存分配zmalloc</a></li>
        
        <li><a href="/post/redis-mongodb%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84%E6%96%B9%E5%BC%8F/">redis_mongodb持久化的方式</a></li>
        
        <li><a href="/post/vue-%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98/">vue 跨域问题</a></li>
        
        <li><a href="/post/axios-%E5%8F%91%E9%80%81post%E8%AF%B7%E6%B1%82/">axios_发送post请求</a></li>
        
        <li><a href="/post/error-inflating-class-fragment/">Error_inflating_class_fragment</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/redis'>redis</a></li>
                
                <li><a href='/tags/source-code'>source code</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="https://siskinc.github.io/">Daryl&#39;s Blog By Daryl</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'Python,Golang', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/douban.js'></script>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://siskinc.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://siskinc.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://siskinc.github.io/post/cpython%E7%9A%84%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/" title="CPython的原子操作">CPython的原子操作</a>
    </li>
    
    <li>
        <a href="https://siskinc.github.io/post/caarlos0-env%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" title="`caarlos0/env`源码阅读">`caarlos0/env`源码阅读</a>
    </li>
    
    <li>
        <a href="https://siskinc.github.io/post/%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2/" title="上下文切换">上下文切换</a>
    </li>
    
    <li>
        <a href="https://siskinc.github.io/post/python%E7%9A%84%E5%85%A8%E5%B1%80%E9%94%81_gil/" title="Python的全局锁(GIL)">Python的全局锁(GIL)</a>
    </li>
    
    <li>
        <a href="https://siskinc.github.io/post/%E5%9B%9B%E8%B1%A1%E9%99%90%E5%B7%A5%E4%BD%9C%E6%B3%95/" title="四象限工作法">四象限工作法</a>
    </li>
    
    <li>
        <a href="https://siskinc.github.io/post/python-language-server-%E6%94%AF%E6%8C%81pydantic/" title="Python Language Server 支持Pydantic">Python Language Server 支持Pydantic</a>
    </li>
    
    <li>
        <a href="https://siskinc.github.io/post/python3%E5%9C%A8%E7%B1%BB%E7%9A%84%E5%86%85%E9%83%A8%E4%BD%BF%E7%94%A8%E5%BD%93%E5%89%8D%E7%B1%BB%E4%BD%9C%E4%B8%BA%E7%B1%BB%E5%9E%8B%E6%8F%90%E7%A4%BA/" title="Python3在类的内部使用当前类作为类型提示">Python3在类的内部使用当前类作为类型提示</a>
    </li>
    
    <li>
        <a href="https://siskinc.github.io/post/golang%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-bufio%E9%98%85%E8%AF%BB/" title="Golang源码阅读 Bufio阅读">Golang源码阅读 Bufio阅读</a>
    </li>
    
    <li>
        <a href="https://siskinc.github.io/post/%E5%BD%93golang%E9%81%87%E8%A7%81%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/" title="当golang遇见工厂模式">当golang遇见工厂模式</a>
    </li>
    
    <li>
        <a href="https://siskinc.github.io/post/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8vscode%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95python/" title="如何使用vscode远程调试Python">如何使用vscode远程调试Python</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://siskinc.github.io/categories/algorithm/">Algorithm (3)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/android/">Android (2)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/c&#43;&#43;/">C&#43;&#43; (3)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/docker/">Docker (5)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/git/">Git (1)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/go/">Go (20)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/golang/">Golang (1)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/javascript/">JavaScript (1)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/k8s/">k8s (1)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/linux/">Linux (6)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/mongodb/">MongoDB (1)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/mysql/">Mysql (1)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/python/">Python (23)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/redis/">Redis (12)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/svn/">SVN (2)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/vscode/">VSCode (1)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/windows/">Windows (1)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/%E5%89%8D%E7%AB%AF/">前端 (4)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统 (2)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/%E7%BB%8F%E9%AA%8C/">经验 (3)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/%E7%BC%96%E7%A0%81/">编码 (2)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络 (1)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式 (1)</a></li>
    
    <li><a href="https://siskinc.github.io/categories/%E8%BD%AF%E6%8A%80%E8%83%BD/">软技能 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://siskinc.github.io/tags/axios/">axios</a>
    
    <a href="https://siskinc.github.io/tags/basic-latin/">Basic Latin</a>
    
    <a href="https://siskinc.github.io/tags/branch/">branch</a>
    
    <a href="https://siskinc.github.io/tags/bug/">bug</a>
    
    <a href="https://siskinc.github.io/tags/cas/">CAS</a>
    
    <a href="https://siskinc.github.io/tags/centos/">centos</a>
    
    <a href="https://siskinc.github.io/tags/convert/">convert</a>
    
    <a href="https://siskinc.github.io/tags/coverage/">coverage</a>
    
    <a href="https://siskinc.github.io/tags/cpu/">CPU</a>
    
    <a href="https://siskinc.github.io/tags/cron-task/">cron task</a>
    
    <a href="https://siskinc.github.io/tags/css/">css</a>
    
    <a href="https://siskinc.github.io/tags/datetime/">datetime</a>
    
    <a href="https://siskinc.github.io/tags/dict/">dict</a>
    
    <a href="https://siskinc.github.io/tags/django/">django</a>
    
    <a href="https://siskinc.github.io/tags/docker/">docker</a>
    
    <a href="https://siskinc.github.io/tags/docker-compose/">docker-compose</a>
    
    <a href="https://siskinc.github.io/tags/eval/">eval</a>
    
    <a href="https://siskinc.github.io/tags/flask/">flask</a>
    
    <a href="https://siskinc.github.io/tags/gevent/">gevent</a>
    
    <a href="https://siskinc.github.io/tags/gil/">GIL</a>
    
    <a href="https://siskinc.github.io/tags/gin/">gin</a>
    
    <a href="https://siskinc.github.io/tags/git/">git</a>
    
    <a href="https://siskinc.github.io/tags/go-redis/">go-redis</a>
    
    <a href="https://siskinc.github.io/tags/golang/">Golang</a>
    
    <a href="https://siskinc.github.io/tags/golang%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">Golang源码阅读</a>
    
    <a href="https://siskinc.github.io/tags/gorm/">gorm</a>
    
    <a href="https://siskinc.github.io/tags/goroutine/">goroutine</a>
    
    <a href="https://siskinc.github.io/tags/gridfs/">gridfs</a>
    
    <a href="https://siskinc.github.io/tags/hash/">hash</a>
    
    <a href="https://siskinc.github.io/tags/hooks/">hooks</a>
    
    <a href="https://siskinc.github.io/tags/http/">http</a>
    
    <a href="https://siskinc.github.io/tags/https/">https</a>
    
    <a href="https://siskinc.github.io/tags/import/">import</a>
    
    <a href="https://siskinc.github.io/tags/init/">init</a>
    
    <a href="https://siskinc.github.io/tags/javascript/">javascript</a>
    
    <a href="https://siskinc.github.io/tags/jquery/">jQuery</a>
    
    <a href="https://siskinc.github.io/tags/json/">json</a>
    
    <a href="https://siskinc.github.io/tags/k8s/">k8s</a>
    
    <a href="https://siskinc.github.io/tags/kafka/">kafka</a>
    
    <a href="https://siskinc.github.io/tags/kafka-go/">kafka-go</a>
    
    <a href="https://siskinc.github.io/tags/linux/">linux</a>
    
    <a href="https://siskinc.github.io/tags/lua/">lua</a>
    
    <a href="https://siskinc.github.io/tags/mac/">mac</a>
    
    <a href="https://siskinc.github.io/tags/map/">map</a>
    
    <a href="https://siskinc.github.io/tags/mgo/">mgo</a>
    
    <a href="https://siskinc.github.io/tags/mongodb/">mongodb</a>
    
    <a href="https://siskinc.github.io/tags/mongoengine/">mongoengine</a>
    
    <a href="https://siskinc.github.io/tags/mysql/">mysql</a>
    
    <a href="https://siskinc.github.io/tags/nodejs/">nodejs</a>
    
    <a href="https://siskinc.github.io/tags/pep8/">PEP8</a>
    
    <a href="https://siskinc.github.io/tags/pipeline/">pipeline</a>
    
    <a href="https://siskinc.github.io/tags/process/">process</a>
    
    <a href="https://siskinc.github.io/tags/proxy/">proxy</a>
    
    <a href="https://siskinc.github.io/tags/pydantic/">Pydantic</a>
    
    <a href="https://siskinc.github.io/tags/python/">python</a>
    
    <a href="https://siskinc.github.io/tags/python-language-server/">Python Language Server</a>
    
    <a href="https://siskinc.github.io/tags/python2/">python2</a>
    
    <a href="https://siskinc.github.io/tags/python3/">python3</a>
    
    <a href="https://siskinc.github.io/tags/python%E7%B1%BB%E5%9E%8B%E6%8F%90%E7%A4%BA/">Python类型提示</a>
    
    <a href="https://siskinc.github.io/tags/redis/">redis</a>
    
    <a href="https://siskinc.github.io/tags/referencefield/">referencefield</a>
    
    <a href="https://siskinc.github.io/tags/restful/">restful</a>
    
    <a href="https://siskinc.github.io/tags/rtti/">RTTI</a>
    
    <a href="https://siskinc.github.io/tags/shell/">shell</a>
    
    <a href="https://siskinc.github.io/tags/source-code/">source code</a>
    
    <a href="https://siskinc.github.io/tags/ss/">ss</a>
    
    <a href="https://siskinc.github.io/tags/ssh/">ssh</a>
    
    <a href="https://siskinc.github.io/tags/svn/">svn</a>
    
    <a href="https://siskinc.github.io/tags/thread/">thread</a>
    
    <a href="https://siskinc.github.io/tags/trap/">trap</a>
    
    <a href="https://siskinc.github.io/tags/uber-h3/">uber h3</a>
    
    <a href="https://siskinc.github.io/tags/ubuntu/">ubuntu</a>
    
    <a href="https://siskinc.github.io/tags/unicode/">Unicode</a>
    
    <a href="https://siskinc.github.io/tags/unique-index/">unique index</a>
    
    <a href="https://siskinc.github.io/tags/uwsgi/">uwsgi</a>
    
    <a href="https://siskinc.github.io/tags/vscode/">vscode</a>
    
    <a href="https://siskinc.github.io/tags/vue/">vue</a>
    
    <a href="https://siskinc.github.io/tags/windows/">windows</a>
    
    <a href="https://siskinc.github.io/tags/wordpress/">wordpress</a>
    
    <a href="https://siskinc.github.io/tags/xshell/">xshell</a>
    
    <a href="https://siskinc.github.io/tags/%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91/">二叉搜索树</a>
    
    <a href="https://siskinc.github.io/tags/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/">交叉编译</a>
    
    <a href="https://siskinc.github.io/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/">单例模式</a>
    
    <a href="https://siskinc.github.io/tags/%E5%9B%BD%E5%86%85%E6%BA%90/">国内源</a>
    
    <a href="https://siskinc.github.io/tags/%E5%B7%A5%E4%BD%9C%E6%96%B9%E6%B3%95%E8%AE%BA/">工作方法论</a>
    
    <a href="https://siskinc.github.io/tags/%E5%B9%82%E6%AC%A1%E5%AE%9A%E5%BE%8B/">幂次定律</a>
    
    <a href="https://siskinc.github.io/tags/%E6%8F%92%E4%BB%B6/">插件</a>
    
    <a href="https://siskinc.github.io/tags/%E6%AC%A1%E4%BC%98%E4%BA%8C%E5%8F%89%E6%A0%91/">次优二叉树</a>
    
    <a href="https://siskinc.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
    
    <a href="https://siskinc.github.io/tags/%E8%B7%A8%E5%9F%9F/">跨域</a>
    
    <a href="https://siskinc.github.io/tags/%E8%BF%90%E7%BB%B4/">运维</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://siskinc.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>